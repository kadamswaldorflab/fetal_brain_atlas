```{r}
setwd("/mmfs1/gscratch/kawaldorflab/jcorn427/fet_brain/fb_03")

library(Seurat)
library(SoupX)
library(ggplot2)
library(dplyr)
library(tidyverse)
library(harmony)
library(scCustomize)
library(scDEED)
library(future)
library(plotly)
library(monocle3)
library(SeuratWrappers)

set.seed(42)
# needs to be set for large dataset analysis
options(future.globals.maxSize = 1e10)
# n_cores <- parallelly::availableCores(constraints = "cluster")
# plan(multisession, workers = n_cores)
# plan(sequential)

fb_merged <- readRDS("fb_merged_v3.RDS")
```
```{r}
# Define paths to data

data_dirs <- list(
  Ctrl13 = '/gscratch/kawaldorflab/megana/CTRL13/outs',
  Ctrl24 = '/gscratch/kawaldorflab/megana/CTRL24/outs',
  Ctrl25 = '/gscratch/kawaldorflab/megana/CTRL25/outs',
  Ctrl26 = '/gscratch/kawaldorflab/megana/CTRL26/outs',
  Ctrl27 = '/gscratch/kawaldorflab/megana/CTRL27/outs',
  Sal7 = '/gscratch/kawaldorflab/megana/SAL7/outs',
  Sal9 = '/gscratch/kawaldorflab/megana/SAL9/outs',
  Sal10 = '/gscratch/kawaldorflab/megana/SAL10/outs',
  Sal13 = '/gscratch/kawaldorflab/megana/SAL13/outs'
)
```
```{r}
# --- Process each sample individually ---
seurat_object_list <- list()

for (sample_name in names(data_dirs)) {
  cat("Processing sample:", sample_name, "\n")
  
  sample_path <- data_dirs[[sample_name]]
  
  # Load raw and filtered data
  raw_counts <- Seurat::Read10X_h5(file.path(sample_path, "raw_feature_bc_matrix.h5"))
  filtered_counts <- Seurat::Read10X_h5(file.path(sample_path, "filtered_feature_bc_matrix.h5"))
  
  # Create preliminary Seurat object for clustering (as before)
  fb_temp <- CreateSeuratObject(counts = filtered_counts)
  fb_temp <- NormalizeData(fb_temp)
  fb_temp <- FindVariableFeatures(fb_temp)
  fb_temp <- ScaleData(fb_temp)
  fb_temp <- RunPCA(fb_temp)
  fb_temp <- FindNeighbors(fb_temp, dims = 1:10)
  fb_temp <- FindClusters(fb_temp, resolution = 0.5)
  prelim_clusters <- fb_temp$seurat_clusters
  
  # --- SoupX correction for the current sample ---
  sc <- SoupChannel(raw_counts, filtered_counts)
  sc <- setClusters(sc, prelim_clusters)
  sc <- autoEstCont(sc)
  corrected_counts <- adjustCounts(sc, roundToInt = TRUE)
  
  # --- Create Seurat object from corrected data ---
  fb <- CreateSeuratObject(counts = corrected_counts, project = sample_name)
  fb$sample <- sample_name # Add sample information to metadata
  
  # --- QC for the current sample ---
  fb[["percent.mt"]] <- PercentageFeatureSet(fb, pattern = "^MT-")
  fb <- subset(fb, subset = nFeature_RNA > 200 & percent.mt < 5)
  
  # Add to the list
  seurat_object_list[[sample_name]] <- fb
}
```

```{r}
# --- Merge the Seurat objects ---
# Merge all objects into a single object
fb_merged <- merge(x = seurat_object_list[[1]], 
                     y = seurat_object_list[2:length(seurat_object_list)], 
                     add.cell.ids = names(data_dirs), 
                     project = "all_samples")
```
```{r}
# --- SCTransform normalization ---
fb_merged <- SCTransform(fb_merged, vars.to.regress = "percent.mt")


# --- Perform PCA on the merged object ---
# It's recommended to run PCA before Harmony
fb_merged <- RunPCA(fb_merged, assay = "SCT", npcs = 50)

ElbowPlot(fb_merged, ndims = 50, reduction = "pca")
# --- Visualize PCA results before Harmony (optional) ---
# This plot will likely show clustering by batch/sample
DimPlot(fb_merged, reduction = "pca", group.by = "sample")

# --- Run Harmony for batch correction ---
fb_merged <- RunHarmony(
  object = fb_merged, 
  group.by.vars = "sample", 
  assay.use = "SCT", 
  reduction.use = "pca",
  reduction.save = "harmony"
)

# --- Visualize Harmony results ---
# This UMAP will use the batch-corrected Harmony embeddings
fb_merged <- RunUMAP(fb_merged, reduction = "harmony", dims = 1:30)
DimPlot(fb_merged, reduction = "umap", group.by = "sample")
```
```{r}
# --- Clustering with Harmony embeddings ---
fb_merged <- FindNeighbors(fb_merged, reduction = "harmony", dims = 1:30)
fb_merged <- FindClusters(fb_merged, resolution = 0.5)

# --- Final UMAP visualization ---
DimPlot_scCustom(fb_merged, reduction = "umap", label = TRUE)
ggsave("init_umap.pdf", width = 10, height = 8, units = "in")

# --- Find marker genes ---
# The marker finding step does not require a reduction
fb_merged.markers <- FindAllMarkers(fb_merged, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
```

```{r}
#saveRDS(fb_merged, file = "fb_merged_pre_scDEED.RDS")
fb_merged <- readRDS("fb_merged_pre_scDEED.RDS")
```


```{r scDEED part 1}
# # Running scDEED to look at our default clustering to look for dubious embedding
# result_orig <- scDEED(fb_merged, K = 40, reduction.method = "umap", default_assay = 'SCT', slot = 'scale.data', rerun = F)
# saveRDS(result_orig, file = 'scDEED_result_orig.RDS')
# # result_orig <- readRDS('scDEED_result_orig.RDS')
# 
# # Pre-scDEED analysis
# min(result_orig$num_dubious$number_dubious_cells)
# opt = which(result_orig$num_dubious$number_dubious_cells==min(result_orig$num_dubious$number_dubious_cells))
# m = result_orig$num_dubious$min.dist[opt]
# n = result_orig$num_dubious$n_neighbors[opt]
# 
# dubious_cells = result_orig$full_results$dubious_cells[opt]
# dubious_cells = as.numeric(strsplit(dubious_cells, ',')[[1]])
# trustworthy_cells =  result_orig$full_results$trustworthy_cells[opt]
# trustworthy_cells = as.numeric(strsplit(trustworthy_cells, ',')[[1]])
# data_orig = RunUMAP(fb_merged, dims = 1:40, min.dist = m, n.neighbors = n, seed.use = 100)
# 
# DimPlot(fb_merged, reduction = 'umap', cells.highlight = list('dubious' = dubious_cells, 'trustworthy' = trustworthy_cells), shuffle = TRUE) + scale_color_manual(values = c('gray', 'blue', 'red'))

```


```{r scDEED part 2}
# # Running scDEED on my data to reduce dubious embedding
# result <- scDEED(fb_merged, K = 40, reduction.method = "umap", default_assay = 'SCT', slot = 'scale.data')
# 
# saveRDS(result, file = 'scDEED_result.RDS')
# # result <- readRDS('scDEED_result.RDS')
# 
# # Post-scDEED analysis
# min(result$num_dubious$number_dubious_cells)
# opt = which(result$num_dubious$number_dubious_cells==min(result$num_dubious$number_dubious_cells))
# m = result$num_dubious$min.dist[opt]
# n = result$num_dubious$n_neighbors[opt]
# 
# dubious_cells = result$full_results$dubious_cells[opt]
# dubious_cells = as.numeric(strsplit(dubious_cells, ',')[[1]])
# trustworthy_cells =  result$full_results$trustworthy_cells[opt]
# trustworthy_cells = as.numeric(strsplit(trustworthy_cells, ',')[[1]])
# data_opt = RunUMAP(fb_merged, dims = 1:40, min.dist = m, n.neighbors = n, seed.use = 100)
# 
# DimPlot(data_opt, reduction = 'umap', cells.highlight = list('dubious' = dubious_cells, 'trustworthy' = trustworthy_cells), shuffle = TRUE) + scale_color_manual(values = c('gray', 'blue', 'red'))
# 
# # Using the new seurat object going forward, will re-run standard pipeline from RunUMAP
# fb_merged <- data_opt
# 
# fb_merged <- FindNeighbors(fb_merged, dims = 1:40)
# fb_merged <- FindClusters(fb_merged, resolution = 0.5)
# 
# # Take a look, use different meta data combinations for split and group to get a better picture
# DimPlot_scCustom(fb_merged, reduction = "umap", label = TRUE)
# 
# saveRDS(fb_merged, file = "fb_merged_scDEED.RDS")
# # fb_merged <- readRDS("fb_merged_scDEED.RDS")

```

```{r}
FeaturePlot(fb_merged, features = "nFeature_RNA")
FeaturePlot(fb_merged, features = "nCount_RNA", max.cutoff = "q50")
```
```{r Top Markers Code, fig.width=20, fig.height=10}
fb_merged <- PrepSCTFindMarkers(fb_merged)

all_markers <- FindAllMarkers(object = fb_merged) %>%
  Add_Pct_Diff() 

# all_markers2 <- all_markers[!grepl("^ENSMMUG", rownames(all_markers)), ]

not_all_markers <- all_markers[grepl(paste(c("13", "17"), collapse = "|"), all_markers$cluster), ]

# not_all_markers <- all_markers2[all_markers2$cluster %in% c(1, 3), ]

top_markers <- Extract_Top_Markers(marker_dataframe = not_all_markers, num_genes = 20, named_vector = FALSE,
                                   make_unique = TRUE, rank_by = "avg_log2FC")
# DotPlot_scCustom(fb_merged, top_markers, x_lab_rotate = TRUE, flip_axes = TRUE)

gradient <- c("blue", "white", "red")

plots <- Clustered_DotPlot(seurat_object = fb_merged, features = top_markers, flip = TRUE, x_lab_rotate = 90)
plots[[1]]

Clustered_DotPlot(seurat_object = fb_merged, features = top_markers, flip = TRUE, x_lab_rotate = 90, k = 2, plot_km_elbow = FALSE, colors_use_exp = gradient)
plots <- Clustered_DotPlot(seurat_object = fb_merged, features = top_markers, flip = TRUE, x_lab_rotate = 90, k = 18, plot_km_elbow = FALSE)




top_100_markers <- Extract_Top_Markers(marker_dataframe = all_markers, num_genes = 100, data_frame = TRUE,
                                      rank_by = "avg_log2FC")
write.csv(all_markers, file = "all_markers.csv")
```

```{r 3D UMAP}
# 3D UMAP
fb_3D <- fb_merged
fb_3D <- RunUMAP(fb_3D, reduction = "harmony", dims = 1:20, n.components = 3L, reduction.name = "umap.harmony_3D")

head(Embeddings(object = fb_3D, reduction = "umap.harmony_3D"))

plot.data <- FetchData(object = fb_3D, vars = c("umapharmony3D_1", "umapharmony3D_2", "umapharmony3D_3", "seurat_clusters"))

plot.data$label <- paste(rownames(plot.data))

fig <- plot_ly(data = plot.data, 
               x = ~umapharmony3D_1, y = ~umapharmony3D_2, z = ~umapharmony3D_3, 
               color = ~seurat_clusters, 
               colors = c("lightseagreen",
                          "gray50",
                          "darkgreen",
                          "red4",
                          "red",
                          "turquoise4",
                          "black",
                          "yellow4",
                          "royalblue1",
                          "lightcyan3",
                          "peachpuff3",
                          "khaki3",
                          "gray20",
                          "orange2",
                          "royalblue4",
                          "yellow3",
                          "gray80",
                          "darkorchid1",
                          "lawngreen",
                          "plum2",
                          "darkmagenta"),
               type = "scatter3d", 
               mode = "markers", 
               marker = list(size = 5, width=2), # controls size of points
               text=~seurat_clusters, #This is that extra column we made earlier for which we will use for cell ID
               hoverinfo="text") #When you visualize your plotly object, hovering your mouse pointer over a point shows cell names
fig
head(plot.data)
```
```{r}
FeaturePlot_scCustom(fb_merged, features = "MKI67")

DotPlot_scCustom(fb_merged, features = c('MKI67', 'PCNA', 'TOP2A', 'ASPM', 'CENPF'), flip_axes = TRUE, x_lab_rotate = TRUE, colors_use = gradient)
```
```{r}
DotPlot_scCustom(fb_merged, features = c('SHH', 'ISL1', 'MEIS2', 'NPAS1', 'NPAS3', "GAD1", "GAD2", 
                                         'KIT', 'SSTR2', 'UNC5B', 'NEUROD6', 'ELMO1', 'EPHA4', 'EFNB3', 'SEMA6A',
                                         'KCNK9', 'TASK3', 'KCNC1', 'SCN1A', 'GABRA1', 'SLC32A1', 'VGAT', 'SLC6A1', 'GAT1',
                                         'PVALB', 'SST', 'NPY', 'CHODL', 'CRYM'), flip_axes = TRUE, x_lab_rotate = TRUE, colors_use = gradient)

```

```{r}
sct_counts <- GetAssayData(object = fb_merged, assay = "SCT", layer = "counts")
sct_counts <- t(sct_counts)
sct_counts_df <- as.data.frame(as.matrix(sct_counts))
write.csv(sct_counts_df, gzfile("sct_counts.csv.gz"), row.names = TRUE)
```
```{r}
allen_brain <- read.csv('allen_brain.csv', header = TRUE)

# Get metadata from main object
meta.data <- fb_merged@meta.data
meta.data <- rownames_to_column(meta.data, var = "cell_id")
meta_data_2 <- left_join(x = meta.data, y = allen_brain, by = "cell_id")

meta_data_2<- meta_data_2 %>% select(cell_id, supercluster_name)

fb_merged <- AddMetaData(fb_merged, meta_data_2)

p1 <- DimPlot_scCustom(fb_merged)

p2 <- DimPlot_scCustom(fb_merged, group.by = "supercluster_name", label = TRUE, repel = TRUE)
plot <- p1+p2
ggsave('allen_brain.pdf', plot = p2, width = 15, height = 8, units = "in")

```
```{r}
#### Seurat to Monocle3 ####

cds <- as.cell_data_set(fb_merged)

plot_cells(cds, color_cells_by="seurat_clusters", show_trajectory_graph=FALSE, reduction_method = "UMAP")
plot_cells()

# Now run the rest of the Monocle3 workflow
cds <- cluster_cells(cds, reduction_method = "UMAP")
cds <- learn_graph(cds, use_partition = TRUE)
cds <- order_cells(cds)

# Plot the trajectory and pseudotime on the Harmony UMAP
plot_cells(cds,
           #color_cells_by = "pseudotime",
           label_cell_groups = TRUE,
           label_leaves = TRUE,
           label_branch_points = TRUE)

plot_cells(cds,
           color_cells_by = "seurat_clusters",
           label_principal_points = TRUE)



cds <- order_cells(cds, root_pr_nodes = c("Y_254", "Y_31", "Y_212", "Y_74"))

plot_cells(cds,
           color_cells_by = "pseudotime",
           show_trajectory_graph = TRUE,
           label_cell_groups = FALSE, # Set to TRUE to label cell groups
           label_leaves = TRUE,
           label_branch_points = TRUE,
           graph_label_size = 1.5)
```

```{r}
FeaturePlot_scCustom(fb_merged, features = "SATB2")
```

```{r}
levels(fb_merged)

initial_clust <- c("OPC",  "MG1",  "2",  "COP1",  "OL",  "5" , "6" , "MG2" , "8",  "9" , "10", "11", "12", "vRG", "14", "COP2" ,"16" ,"vRG" ,"18", "19", "MG0", "21", "FIB", "BAM", "24")

names(initial_clust) <- levels(fb_merged)
fb_merged <- RenameIdents(fb_merged, initial_clust)
DimPlot_scCustom(fb_merged, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

fb_merged$cell_type_v11 <- Idents(fb_merged)

saveRDS(fb_merged, file = "fb_merged_v12.RDS")

```
```{r}
fb_merged2 <- FindSubCluster(object = fb_merged, cluster = "12",graph.name = "SCT_snn", resolution = 0.1, subcluster.name = "sub")

DimPlot_scCustom(fb_merged2, reduction = "umap", group.by = "sub", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
```
```{r, fig.width= 20, fig.height= 8}
FeaturePlot(fb_merged2, features = c("SATB2", "SLC17A7"), blend = TRUE)
```
```{r}
levels(fb_merged2)
Idents(fb_merged2) <- "sub"

initial_clust <- c("ExN" ,"OPC"  ,"2",    "COP1", "OL",   "21" ,  "5"  ,  "16"   ,"8"  ,  "19" ,  "10" ,  "9"  ,  "MG1"  ,"vRG"  ,"6",    "11" ,  "14" ,  "COP2", "18" ,  "IPC" ,"12_2", "MG2",  "MG0" , "BAM" , "24" ,  "FIB")

names(initial_clust) <- levels(fb_merged2)
fb_merged2 <- RenameIdents(fb_merged2, initial_clust)
DimPlot_scCustom(fb_merged2, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

fb_merged$cell_type_v11 <- Idents(fb_merged)

saveRDS(fb_merged, file = "fb_merged_v12.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged2, features = c('NKX2-1', 'LHX6', 'LAMP5', 'SOX6'), num_columns = 2)
```
```{r}
fb_merged3 <- FindSubCluster(object = fb_merged2, cluster = "2",graph.name = "SCT_snn", resolution = 0.2, subcluster.name = "sub2")

DimPlot_scCustom(fb_merged3, reduction = "umap", group.by = "sub2", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
```
```{r}
genes_of_interest <- c("NKX2-1", "LHX6")
cluster_to_subset <- "2" 
subset_object <- subset(fb_merged2, idents = cluster_to_subset)

subset_object <- NormalizeData(subset_object)
VariableFeatures(object = subset_object) <- genes_of_interest
subset_object <- ScaleData(subset_object, features = genes_of_interest)
subset_object <- RunPCA(subset_object, features = genes_of_interest)
expression_data <- FetchData(subset_object, vars = c("NKX2-1", "LHX6"))

FeaturePlot_scCustom(subset_object, features = c("NKX2-1", "LHX6"))

nkx21_threshold <- 0.3
lhx6_threshold <- 0.3


subset_object$expression_status <- "Below_Threshold" # Default label

cells_above_threshold_bool <- expression_data$"NKX2-1" > nkx21_threshold | expression_data$"LHX6" > lhx6_threshold

subset_object$expression_status[cells_above_threshold_bool] <- "Above_Threshold"

# Set the new identities as the active identity
Idents(subset_object) <- subset_object$expression_status

# Visualize the result
DimPlot(subset_object, reduction = "umap", label = FALSE, shuffle = TRUE)


```
```{r}
levels(subset_object)
initial_clust <- c("CGE", "MGE")

names(initial_clust) <- levels(subset_object)
subset_object <- RenameIdents(subset_object, initial_clust)
DimPlot_scCustom(subset_object, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE, shuffle = TRUE)

subset_object$cge_mge <- Idents(subset_object)

```
```{r}
cluster_to_subset <- "CGE" 
subset_object2 <- subset(subset_object, idents = cluster_to_subset)
FeaturePlot_scCustom(subset_object2, features = c('NR2F2', 'PROX1', 'FEZF2', 'GAD1', 'DLX1', 'DLX2'), num_columns = 3)
```
```{r}
# Add labels back into main UMAP
CellsMetaTrim <- subset(subset_object@meta.data, select = c("cge_mge"))
fb_merged3 <- AddMetaData(fb_merged2, CellsMetaTrim)

meta.data <- fb_merged3@meta.data

meta.data <- meta.data %>% mutate(cell_type_v1 = coalesce(cge_mge, sub))
clusters <- subset(meta.data, select = c("cell_type_v1"))
fb_merged3 <- AddMetaData(fb_merged3, clusters)

fb_merged3$sub <- NULL
fb_merged3$cge_mge <- NULL

head(fb_merged3@meta.data)
levels(fb_merged3)
Idents(fb_merged3) <- "cell_type_v1"

DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE, shuffle = TRUE)

saveRDS(fb_seurat_2, file = "fb_seurat_v8.RDS")
```
```{r}
levels(fb_merged3)


initial_clust <- c("ExN", "OPC" , "CGE" , "COP1", "OL" ,  "21" ,  "5"  ,  "16" ,  "8" ,   "19" ,  "10" ,  "9"  ,  "MG1" , "vRG",  "6" ,   "11" ,  "14",   "COP2", "18",   "IPC", "12_2", "MG2" , "MG0",  "BAM",  "24",   "MGE" , "FIB")

names(initial_clust) <- levels(fb_merged3)
fb_merged3 <- RenameIdents(fb_merged3, initial_clust)
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

fb_merged3$cell_type_v2 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v2.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c("VIP", "CR", "RELN", "CCK", "TAC3", 'SST', 'PVALB', 'NPY', 'NOS1', 'CRYM', 'CHODL'), num_columns = 4)
```
```{r}
cluster_to_subset <- "12_2" 
subset_object2 <- subset(fb_merged3, idents = cluster_to_subset)
FeaturePlot_scCustom(subset_object2, features = c("VIP", "CR", "RELN", "CCK", "TAC3", 'SST', 'PVALB', 'NPY', 'NOS1', 'CRYM', 'CHODL'), num_columns = 4)
```



```{r}
levels(fb_merged3)


initial_clust <- c("ExN", "OPC" , "CGE0" , "COP1", "OL" ,  "21" ,  "5"  ,  "16" ,  "8" ,   "19" ,  "10" ,  "9"  ,  "MG1" , "vRG",  "6" ,   "11" ,  "14",   "COP2", "18",   "IPC", "CGE1", "MG2" , "MG0",  "BAM",  "24",   "MGE" , "FIB")

names(initial_clust) <- levels(fb_merged3)
fb_merged3 <- RenameIdents(fb_merged3, initial_clust)
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('TTR', 'KRT18', 'KRT8', 'AQP1', 'CLDN1', 'CLDN3', 'EPCAM', 'CDH1', 'GJA1'), num_columns = 3)
```
```{r}
# Generate the UMAP plot
plot <- DimPlot(object = fb_merged3, reduction = "umap")

# Pass the plot to CellSelector()
# The R console will prompt you to select points on the plot
cells.located <- CellSelector(plot = plot)
# Create a new identity class for the selected cells
fb_merged3 <- SetIdent(fb_merged3, cells = cells.located, value = 'selected_cells')

# Verify the selection with a new plot
DimPlot(fb_merged3, reduction = "umap", group.by = 'ident')

fb_merged3$lasso <- Idents(fb_merged3)

saveRDS(fb_merged3, 'fb_merged_v3.RDS')

```
```{r}
levels(fb_merged3)
fb_merged3 <- RenameIdents(fb_merged3, c("selected_cells" = "ChP", "6" = "Ep"))
fb_merged3$cell_type_v3 <- Idents(fb_merged3)
saveRDS(fb_merged3, 'fb_merged_v3.RDS')
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('MOBP', 'MBP', 'MAL', 'MOG', 'OPALIN'), num_columns = 3)
```
```{r}
fb_merged3 <- FindSubCluster(object = fb_merged3, cluster = "COP2",graph.name = "SCT_snn", resolution = 0.1, subcluster.name = "sub")

DimPlot_scCustom(fb_merged3, reduction = "umap", group.by = "sub", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
```
```{r}
levels(fb_merged3)
Idents(fb_merged3) <- "sub"
fb_merged3 <- RenameIdents(fb_merged3, c("COP2_0" = "OL2", "COP2_1" = "COP2", "OL" = "OL1"))
fb_merged3$cell_type_v3 <- Idents(fb_merged3)
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

saveRDS(fb_merged3, 'fb_merged_v3.RDS')
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('CD3D', 'MS4A1', 'CD19', 'IGHM', 'CD79A', 'IGHD'), num_columns = 3)
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, c("COP2_0" = "OL2", "COP2_1" = "COP2", "OL" = "OL1"))
```
```{r}
# Generate the UMAP plot
plot <- DimPlot(object = fb_merged3, reduction = "umap")

# Pass the plot to CellSelector()
# The R console will prompt you to select points on the plot
cells.located <- CellSelector(plot = plot)
# Create a new identity class for the selected cells
fb_merged3 <- SetIdent(fb_merged3, cells = cells.located, value = 'B')

# Verify the selection with a new plot
DimPlot(fb_merged3, reduction = "umap", group.by = 'ident')

fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, 'fb_merged_v3.RDS')
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('GFAP', 'S100B', 'ALDH1L1', 'NFIA'), num_columns = 3)
FeaturePlot_scCustom(fb_merged3, features = c('VIM', 'FABP7', 'PAX6', 'SOX9'), num_columns = 3)
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "goRG" = "oRG-G")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)

```
```{r}
FeaturePlot_scCustom(fb_merged3, features = 'AQP4')
```
```{r, fig.width= 20}
all_markers <- FindAllMarkers(object = fb_merged3) %>%
  Add_Pct_Diff() 

# all_markers2 <- all_markers[!grepl("^ENSMMUG", rownames(all_markers)), ]

not_all_markers <- all_markers[grepl(paste(c("5", "14", "19"), collapse = "|"), all_markers$cluster), ]

# not_all_markers <- all_markers2[all_markers2$cluster %in% c(1, 3), ]

top_markers <- Extract_Top_Markers(marker_dataframe = not_all_markers, num_genes = 20, named_vector = FALSE,
                                   make_unique = TRUE, rank_by = "avg_log2FC")
# DotPlot_scCustom(fb_merged, top_markers, x_lab_rotate = TRUE, flip_axes = TRUE)

gradient <- c("blue", "white", "red")

plots <- Clustered_DotPlot(seurat_object = fb_merged3, features = top_markers, flip = TRUE, x_lab_rotate = 90)
plots[[1]]

Clustered_DotPlot(seurat_object = fb_merged3, features = top_markers, flip = TRUE, x_lab_rotate = 90, k = 3, plot_km_elbow = FALSE, colors_use_exp = gradient)
plots <- Clustered_DotPlot(seurat_object = fb_merged, features = top_markers, flip = TRUE, x_lab_rotate = 90, k = 18, plot_km_elbow = FALSE)




top_100_markers <- Extract_Top_Markers(marker_dataframe = all_markers, num_genes = 100, data_frame = TRUE,
                                      rank_by = "avg_log2FC")
write.csv(all_markers, file = "all_markers.csv")
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "24" = "MG1")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "16" = "PC")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('PAX6', 'SOX2', 'VIM', 'FABP7', "BLBP", "HES1", "HES5", "GLI3", "NES"), num_columns = 3)
FeaturePlot_scCustom(fb_merged3, features = c('SLC1A2', 'EAAT2', 'SLC1A3', 'AQP4'), num_columns = 3)
FeaturePlot_scCustom(fb_merged3, features = c('GJA1', 'SPARCL1', 'THBS1', 'THBS2', 'APOE', 'CLU'), num_columns = 3)

```

```{r}
FeaturePlot_scCustom(fb_merged3, features = "GFAP")
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "11" = "AS2")
fb_merged3 <- RenameIdents(fb_merged3, c("19" = "AS1", "14" = "AS1", "5" = "AS1"))
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('SLC17A6', 'VGLUT2', 'GBX2', 'LHX9', 'FOXP2', 'RORA', 'TCF7L2', 'NR4A2', 'CAMK2A', 'GRIA2', 'CACNA1G', 'GAD1', 'GAD2', 'SATB2', 'SLC17A7'), num_columns = 5)

```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('SLC17A7', 'VGLUT1', 'CAMK2A', 'GRIN1', 'NEUROD2', 'CHD5', 'PRDM8'), num_columns = 3)
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "8" = "EC")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "10" = "UP/I")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('SYN1', 'SYN2', 'SYP', 'SNAP25', 'VAMP2', 'DNM1', 'CPLX1', 'STX1A', 'RAB3A'), num_columns = 3)

```
```{r}
fb_merged3 <- RenameIdents(fb_merged3, "ExN" = "ExN0")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```
```{r}
FeaturePlot_scCustom(fb_merged3, features = c('ASCL1', 'GSX2', 'DLL1', 'DLL3', 'EGFR'), num_columns = 3)
FeaturePlot_scCustom(fb_merged3, features = c('FOXP2', 'FOXP4', 'SEZ6', 'RGS7', 'ARC'), num_columns = 3)
FeaturePlot_scCustom(fb_merged3, features = c('RORB', 'ETV1', 'SYT12', 'NEUROD4'), num_columns = 2)
FeaturePlot_scCustom(fb_merged3, features = c('MEIS2', 'FOXP1', 'FOXP2', 'EBF1', "ISL1"), num_columns =3)
FeaturePlot_scCustom(fb_merged3, features = c('NR2F2', 'PROX1', 'HTR3A', 'RELN', 'VIP', 'SCGN'), num_columns =3)

FeaturePlot_scCustom(fb_merged3, features = c('NKX2-1', 'LHX6', 'SOX6'), num_columns =2)

```
```{r}

```

```{r}
fb_merged3 <- RenameIdents(fb_merged3, "9" = "LGE")
DimPlot_scCustom(fb_merged3, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged3$cell_type_v3 <- Idents(fb_merged3)

saveRDS(fb_merged3, file = "fb_merged_v3.RDS")
```




```{r}
FeaturePlot_scCustom(fb_merged, features = c('CD68', 'CD163', 'CCR2', 'S100A8', 'S100A9', 'LYZ', "FCN1", "CD14", "FCGR3A", "MPO", "CXCR1", "SPI1"), num_columns =  4)
```
```{r}
DotPlot_scCustom(fb_merged, c('CD68', 'CD163', 'CCR2', 'S100A8', 'S100A9', 'LYZ', "FCN1", "CD14", "FCGR3A", "MPO", "CXCR1", "SPI1"), x_lab_rotate = TRUE, flip_axes = TRUE)
```
```{r}
fb_merged <- RenameIdents(fb_merged, "B" = "Mono")
DimPlot_scCustom(fb_merged, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = TRUE)
fb_merged$cell_type_v3 <- Idents(fb_merged)

saveRDS(fb_merged, file = "fb_merged_v3.RDS")
```
```{r}
fb_merged2 <- FindSubCluster(object = fb_merged, cluster = "LGE",graph.name = "SCT_snn", resolution = 0.2, subcluster.name = "sub")

DimPlot_scCustom(fb_merged2, reduction = "umap", group.by = "sub", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = FALSE)
```
```{r}
Idents(fb_merged2) <- "sub"
all_markers <- FindAllMarkers(object = fb_merged2) %>%
  Add_Pct_Diff() 

# all_markers2 <- all_markers[!grepl("^ENSMMUG", rownames(all_markers)), ]

not_all_markers <- all_markers[grepl(paste(c("COP1", "COP2", "OL1", "OL2"), collapse = "|"), all_markers$cluster), ]

# not_all_markers <- all_markers2[all_markers2$cluster %in% c(1, 3), ]

top_markers <- Extract_Top_Markers(marker_dataframe = not_all_markers, num_genes = 20, named_vector = FALSE,
                                   make_unique = TRUE, rank_by = "avg_log2FC")
# DotPlot_scCustom(fb_merged, top_markers, x_lab_rotate = TRUE, flip_axes = TRUE)

gradient <- c("blue", "white", "red")

plots <- Clustered_DotPlot(seurat_object = fb_merged2, features = top_markers, flip = TRUE, x_lab_rotate = 90)
plots[[1]]
clusters <- c("OL1", "OL2", "COP1", "COP2")
plots <- Clustered_DotPlot(seurat_object = fb_merged, features = top_markers, flip = TRUE, x_lab_rotate = 90, k = 18, plot_km_elbow = FALSE)

subset_obj <- subset(fb_merged2, idents = clusters)
subset_obj@active.ident <- factor(subset_obj@active.ident, levels = clusters)

Clustered_DotPlot(
  seurat_object = subset_obj, 
  features = top_markers, 
  flip = TRUE, 
  x_lab_rotate = 90, 
  k = 2, 
  plot_km_elbow = FALSE, 
  colors_use_exp = gradient # Include your gradient here if it works
  # Do NOT use the 'idents' parameter here, as the object is already subsetted
)

top_100_markers <- Extract_Top_Markers(marker_dataframe = all_markers, num_genes = 100, data_frame = TRUE,
                                      rank_by = "avg_log2FC")
write.csv(all_markers, file = "all_markers.csv")
```
```{r}
plot <- DotPlot_scCustom(fb_merged2, features = top_markers, group.by = "cell_type_v3", remove_axis_titles = FALSE,  flip_axes = FALSE, x_lab_rotate = TRUE, colors_use = gradient) + labs(x = "Gene", y = "Cluster")

plot_filtered <- plot + 
  scale_y_discrete(limits = c("OL1", "OL2", "COP1", "COP2")) # Insert clusters to display here
plot_filtered
```

```{r}
#### Seurat to Monocle3 ####

cds <- as.cell_data_set(fb_merged)

plot_cells(cds, color_cells_by="seurat_clusters", show_trajectory_graph=FALSE, reduction_method = "UMAP")

# Now run the rest of the Monocle3 workflow
cds <- cluster_cells(cds, reduction_method = "UMAP")
cds <- learn_graph(cds, use_partition = TRUE)
cds <- order_cells(cds)

# Plot the trajectory and pseudotime on the Harmony UMAP
plot_cells(cds,
           #color_cells_by = "pseudotime",
           label_cell_groups = TRUE,
           label_leaves = TRUE,
           label_branch_points = TRUE)

plot_cells(cds,
           color_cells_by = "seurat_clusters",
           label_principal_points = TRUE)



cds <- order_cells(cds, root_pr_nodes = c("Y_254", "Y_31", "Y_212", "Y_74"))

plot_cells(cds,
           color_cells_by = "pseudotime",
           show_trajectory_graph = TRUE,
           label_cell_groups = FALSE, # Set to TRUE to label cell groups
           label_leaves = TRUE,
           label_branch_points = TRUE,
           graph_label_size = 1.5)
```

```{r}
umap_coords <- as.data.frame(fb_merged@reductions$umap@cell.embeddings)
genes_to_plot <- c("PDGFRA", "PCDH15", "BCAS1", "MAL")

if (!all(genes_to_plot %in% rownames(fb_merged))) {
  stop("One or more genes not found in the Seurat object.")
}

expression_data <- FetchData(object = fb_merged, vars = genes_to_plot)
background_data <- umap_coords

plot_data <- cbind(umap_coords, expression_data)

long_data <- plot_data %>%
  pivot_longer(
    cols = all_of(genes_to_plot),
    names_to = "gene",
    values_to = "expression"
  ) %>%
  filter(expression > 0)

shuffled_data <- long_data %>%
  sample_frac(1)

# Define a single color gradient for the expression legend
expression_gradient_colors <- c("yellow", "orange", "red") 

ggplot() +
  # 1. Plot all cells as a light grey background layer
  geom_point(data = background_data,
             aes(x = umap_1, y = umap_2),
             color = "lightgrey",
             size = 0.5,
             alpha = 0.5) +
  
  # 2. Plot the shuffled, expressing cells on top
  geom_point(data = shuffled_data,
             aes(x = umap_1, y = umap_2, color = gene, alpha = expression),
             size = 0.8) +
  
  # Set manual colors for the 'color' aesthetic (gene identity)
  scale_color_manual(values = c("PDGFRA" = "green",
                                "PCDH15" = "blue",
                                "BCAS1" = "orange",
                                "MAL" = "red")) +
                                
  # Control the alpha scale. Use guide_legend() to show alpha variations correctly.
  scale_alpha_continuous(
    range = c(0.1, 0.8),
    name = "Expression Level (Opacity)",
    # Change from guide_colorbar() to guide_legend()
    guide = guide_legend(title.position = "top", title.hjust = 0.5) 
  ) + 

  # Use guides() to override the *color* legend's appearance
  guides(
    color = guide_legend(title = "Gene Identity", override.aes = list(size = 4, alpha = 0.8)),
    # Use guides() to further customize the alpha legend if needed
    alpha = guide_legend(override.aes = list(size = 4, color = "black"))
  ) +
  labs(title = "BCAS1, MAL, PCDH15, PDGFRA with Opacity by Expression") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

```{r}
umap_coords <- as.data.frame(fb_merged@reductions$umap@cell.embeddings)
genes_to_plot <- c("EOMES", "SATB2", "GAD1")

if (!all(genes_to_plot %in% rownames(fb_merged))) {
  stop("One or more genes not found in the Seurat object.")
}

expression_data <- FetchData(object = fb_merged, vars = genes_to_plot)
background_data <- umap_coords

plot_data <- cbind(umap_coords, expression_data)

long_data <- plot_data %>%
  pivot_longer(
    cols = all_of(genes_to_plot),
    names_to = "gene",
    values_to = "expression"
  ) %>%
  filter(expression > 0)

shuffled_data <- long_data %>%
  sample_frac(1)

ggplot() +
  # 1. Plot all cells as a light grey background layer
  geom_point(data = background_data,
             aes(x = umap_1, y = umap_2),
             color = "lightgrey",
             size = 0.5,
             alpha = 0.5) +
  
  # 2. Plot the shuffled, expressing cells on top
  geom_point(data = shuffled_data,
             aes(x = umap_1, y = umap_2, color = gene, alpha = expression),
             size = 0.8) +
  
  # Set manual colors for the 'color' aesthetic (gene identity)
  scale_color_manual(values = c("EOMES" = "green",
                                "SATB2" = "blue",
                                "GAD1" = "orange")) +
                                
  # Control the alpha scale. Use guide_legend() to show alpha variations correctly.
  scale_alpha_continuous(
    range = c(0.1, 0.8),
    name = "Expression Level (Opacity)",
    # Change from guide_colorbar() to guide_legend()
    guide = guide_legend(title.position = "top", title.hjust = 0.5) 
  ) + 

  # Use guides() to override the *color* legend's appearance
  guides(
    color = guide_legend(title = "Gene Identity", override.aes = list(size = 4, alpha = 0.8)),
    # Use guides() to further customize the alpha legend if needed
    alpha = guide_legend(override.aes = list(size = 4, color = "black"))
  ) +
  labs(title = "EOMES, GAD1, SATB2 with Opacity by Expression") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

```{r}
umap_coords <- as.data.frame(fb_merged@reductions$umap@cell.embeddings)
genes_to_plot <- c("TBR1", "PROX1", "LHX6")

if (!all(genes_to_plot %in% rownames(fb_merged))) {
  stop("One or more genes not found in the Seurat object.")
}

expression_data <- FetchData(object = fb_merged, vars = genes_to_plot)
background_data <- umap_coords

plot_data <- cbind(umap_coords, expression_data)

long_data <- plot_data %>%
  pivot_longer(
    cols = all_of(genes_to_plot),
    names_to = "gene",
    values_to = "expression"
  ) %>%
  filter(expression > 0)

shuffled_data <- long_data %>%
  sample_frac(1)

ggplot() +
  # 1. Plot all cells as a light grey background layer
  geom_point(data = background_data,
             aes(x = umap_1, y = umap_2),
             color = "lightgrey",
             size = 0.5,
             alpha = 0.5) +
  
  # 2. Plot the shuffled, expressing cells on top
  geom_point(data = shuffled_data,
             aes(x = umap_1, y = umap_2, color = gene, alpha = expression),
             size = 0.8) +
  
  # Set manual colors for the 'color' aesthetic (gene identity)
  scale_color_manual(values = c("TBR1" = "green",
                                "PROX1" = "blue",
                                "LHX6" = "orange")) +
                                
  # Control the alpha scale. Use guide_legend() to show alpha variations correctly.
  scale_alpha_continuous(
    range = c(0.1, 0.8),
    name = "Expression Level (Opacity)",
    # Change from guide_colorbar() to guide_legend()
    guide = guide_legend(title.position = "top", title.hjust = 0.5) 
  ) + 

  # Use guides() to override the *color* legend's appearance
  guides(
    color = guide_legend(title = "Gene Identity", override.aes = list(size = 4, alpha = 0.8)),
    # Use guides() to further customize the alpha legend if needed
    alpha = guide_legend(override.aes = list(size = 4, color = "black"))
  ) +
  labs(title = "LHX6, PROX1, TBR1 with Opacity by Expression") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

```{r}
umap_coords <- as.data.frame(fb_merged@reductions$umap@cell.embeddings)
genes_to_plot <- c("EBF1", "SP8")

if (!all(genes_to_plot %in% rownames(fb_merged))) {
  stop("One or more genes not found in the Seurat object.")
}

expression_data <- FetchData(object = fb_merged, vars = genes_to_plot)
background_data <- umap_coords

plot_data <- cbind(umap_coords, expression_data)

long_data <- plot_data %>%
  pivot_longer(
    cols = all_of(genes_to_plot),
    names_to = "gene",
    values_to = "expression"
  ) %>%
  filter(expression > 0)

shuffled_data <- long_data %>%
  sample_frac(1)

ggplot() +
  # 1. Plot all cells as a light grey background layer
  geom_point(data = background_data,
             aes(x = umap_1, y = umap_2),
             color = "lightgrey",
             size = 0.5,
             alpha = 0.5) +
  
  # 2. Plot the shuffled, expressing cells on top
  geom_point(data = shuffled_data,
             aes(x = umap_1, y = umap_2, color = gene, alpha = expression),
             size = 0.8) +
  
  # Set manual colors for the 'color' aesthetic (gene identity)
  scale_color_manual(values = c("EBF1" = "blue",
                                "SP8" = "orange")) +
                                
  # Control the alpha scale. Use guide_legend() to show alpha variations correctly.
  scale_alpha_continuous(
    range = c(0.1, 0.8),
    name = "Expression Level (Opacity)",
    # Change from guide_colorbar() to guide_legend()
    guide = guide_legend(title.position = "top", title.hjust = 0.5) 
  ) + 

  # Use guides() to override the *color* legend's appearance
  guides(
    color = guide_legend(title = "Gene Identity", override.aes = list(size = 4, alpha = 0.8)),
    # Use guides() to further customize the alpha legend if needed
    alpha = guide_legend(override.aes = list(size = 4, color = "black"))
  ) +
  labs(title = "EBF1, SP8 with Opacity by Expression") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

```{r}
umap_coords <- as.data.frame(fb_merged@reductions$umap@cell.embeddings)
genes_to_plot <- c("NR2F1", "NR2F2", "PROX1")

if (!all(genes_to_plot %in% rownames(fb_merged))) {
  stop("One or more genes not found in the Seurat object.")
}

expression_data <- FetchData(object = fb_merged, vars = genes_to_plot)
background_data <- umap_coords

plot_data <- cbind(umap_coords, expression_data)

long_data <- plot_data %>%
  pivot_longer(
    cols = all_of(genes_to_plot),
    names_to = "gene",
    values_to = "expression"
  ) %>%
  filter(expression > 0)

shuffled_data <- long_data %>%
  sample_frac(1)

ggplot() +
  # 1. Plot all cells as a light grey background layer
  geom_point(data = background_data,
             aes(x = umap_1, y = umap_2),
             color = "lightgrey",
             size = 0.5,
             alpha = 0.5) +
  
  # 2. Plot the shuffled, expressing cells on top
  geom_point(data = shuffled_data,
             aes(x = umap_1, y = umap_2, color = gene, alpha = expression),
             size = 0.8) +
  
  # Set manual colors for the 'color' aesthetic (gene identity)
  scale_color_manual(values = c("NR2F1" = "green",
                                "NR2F2" = "blue",
                                "PROX1" = "orange")) +
                                
  # Control the alpha scale. Use guide_legend() to show alpha variations correctly.
  scale_alpha_continuous(
    range = c(0.1, 0.8),
    name = "Expression Level (Opacity)",
    # Change from guide_colorbar() to guide_legend()
    guide = guide_legend(title.position = "top", title.hjust = 0.5) 
  ) + 

  # Use guides() to override the *color* legend's appearance
  guides(
    color = guide_legend(title = "Gene Identity", override.aes = list(size = 4, alpha = 0.8)),
    # Use guides() to further customize the alpha legend if needed
    alpha = guide_legend(override.aes = list(size = 4, color = "black"))
  ) +
  labs(title = "NR2F1, NR2F2, PROX1 with Opacity by Expression") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 12)
  )

```

```{r}
fb_merged <- RenameIdents(fb_merged, "LGE" = "AS0")
DimPlot_scCustom(fb_merged, reduction = "umap", label = TRUE, pt.size = 0.5, repel = TRUE, label.box = FALSE)
fb_merged$cell_type_v3 <- Idents(fb_merged)

saveRDS(fb_merged, file = "fb_merged_v3.RDS")
```
```{r}
DimPlot_scCustom(fb_merged, repel = TRUE, label.box = TRUE)
```





